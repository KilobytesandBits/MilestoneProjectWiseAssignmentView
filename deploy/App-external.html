<!DOCTYPE html>
<html>
<head>
    <title>milestone-team-wise-assignment</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._createMilestoneWaspiDataStore()},_createMilestoneWaspiDataStore:function(){Ext.getBody().mask("Loading..."),console.log("Rally.environment.getContext().getProject()._ref : ",Rally.environment.getContext().getProject()._ref);var filter;filter=Ext.create("Rally.data.wsapi.Filter",{property:"TargetProject",operator:"=",value:Rally.environment.getContext().getProject()._ref}),milestoneWaspiDataStore=Ext.create("Rally.data.wsapi.Store",{model:"Milestone",autoLoad:!0,compact:!1,context:{workspace:Rally.environment.getContext().getWorkspace()._ref,project:Rally.environment.getContext().getProject()._ref,projectScopeUp:!1,projectScopeDown:!0},filters:filter,fetch:["ObjectID","FormattedID","Name","TargetDate","TargetProject","c_ActiveStartDate"],limit:1/0,listeners:{load:function(store,data,success){data.length>0?this._createMilestoneDataStore(data):Rally.ui.notify.Notifier.showError({message:"No Milestone is associated with the selected Project."}),Ext.getBody().unmask()},scope:this},sorters:[{property:"Name",direction:"ASC"}]})},_createMilestoneDataStore:function(myData){var milestoneArr=[];Ext.each(myData,function(data,index){var milestone={};milestone.ObjectID=data.data.ObjectID,milestone.FormattedID=data.data.FormattedID,milestone.Name=data.data.Name,milestone.TargetDate=data.data.TargetDate,milestone.TargetProject=data.data.TargetProject,milestone.ActiveStartDate=data.data.c_ActiveStartDate,milestoneArr.push(milestone)}),this.milestoneDataStore=Ext.create("Ext.data.Store",{fields:["ObjectID","FormattedID","Name","TargetDate","TargetProject","ActiveStartDate"],data:milestoneArr}),this._createMilestonePicker()},_createMilestonePicker:function(){this.milestonePicker=Ext.create("Ext.form.ComboBox",{fieldLabel:"Milestone ",store:this.milestoneDataStore,renderTo:Ext.getBody(),displayField:"Name",queryMode:"local",valueField:"ObjectID",border:1,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px",height:"40px"},width:400,padding:"10 5 5 10",margin:"10 5 5 10",shadow:"frame",labelAlign:"right",labelStyle:{margin:"10 5 5 10"},listeners:{select:function(combo,records,eOpts){this.selectedMilestone=combo.getValue(),this.selectedMilestoneObj=records,this._loadArtifacts()},scope:this}}),this.add(this.milestonePicker)},_loadArtifacts:function(){Ext.getBody().mask("Generating Report...");var that=this;return Ext.create("Rally.data.wsapi.artifact.Store",{models:["portfolioitem/feature","userstory"],context:{workspace:that.getContext().getWorkspace()._Ref,project:null,limit:1/0,projectScopeUp:!1,projectScopeDown:!0},filters:[{property:"Milestones.ObjectID",operator:"=",value:that.selectedMilestone}]}).load().then({success:function(artifacts){this.artifactsData=artifacts,this._getGridData()},scope:this})},_getGridData:function(){var that=this;Ext.create("Rally.data.wsapi.Store",{model:"User Story",autoLoad:!0,compact:!1,context:{workspace:Rally.environment.getContext().getWorkspace()._ref,project:Rally.environment.getContext().getProject()._ref,projectScopeUp:!1,projectScopeDown:!0},filters:that._getGridFilter(),fetch:["FormattedID","Name","Feature","Project","ScheduleState"],limit:1/0,listeners:{load:function(store,data,success){that._drawGrid(store)},scope:this},sorters:[{property:"Feature",direction:"ASC"}]})},_getGridFilter:function(){var filter=null;return Ext.Array.each(this.artifactsData,function(artifactData){filter="Feature"===artifactData.get("PortfolioItemTypeName")?null===filter?Ext.create("Rally.data.wsapi.Filter",{property:"Feature.ObjectID",operator:"=",value:artifactData.getId()}):filter.or(Ext.create("Rally.data.wsapi.Filter",{property:"Feature.ObjectID",operator:"=",value:artifactData.getId()})):null===filter?Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",operator:"=",value:artifactData.getId()}):filter.or(Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",operator:"=",value:artifactData.getId()}))}),filter},_drawGrid:function(gridStore){var that=this;that.down("#ExportBtn")&&that.down("#ExportBtn").destroy();var exportBtn=Ext.create("Ext.Button",{id:"ExportBtn",text:"Export",scale:"large",cls:"custExprtBtnCls",handler:function(){alert("Export")}});this.add(exportBtn),that.down("rallygrid")&&that.down("rallygrid").destroy(),this.add({xtype:"rallygrid",columnCfgs:[{text:"Formated ID",dataIndex:"FormattedID"},{text:"Name",dataIndex:"Name"},{text:"Parent Feature",dataIndex:"Feature"},{text:"Project",dataIndex:"Project"},{text:"Schedule State",dataIndex:"ScheduleState"}],store:gridStore,enableEditing:!1}),Ext.getBody().unmask()}});

            Rally.launchApp('CustomApp', {
                name:"milestone-team-wise-assignment",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app .custExprtBtnCls{margin-left:20px;padding:10px}.app .custExprtBtnCls:HOVER{background-color:#ff6d29}
    </style>
</head>
<body>
</body>
</html>
